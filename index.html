<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Conversor XLSX → CSV (múltiplas abas)</title>

  <!-- ✅ Biblioteca local -->
  <script src="./xlsx.full.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 24px;
    }
    h1 { margin: 0; font-size: 20px; color: #111827; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 8px 25px rgba(0,0,0,.05);
      max-width: 1100px;
      width: 100%;
    }
    label { display: inline-block; margin-bottom: 8px; font-weight: 600; }
    input[type="file"] { display: block; padding: 8px 0; }
    #status { margin-top: 10px; font-size: 14px; color: #374151; }
    textarea {
      width: 100%;
      min-height: 220px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size: 13px;
      white-space: pre;
    }
    .btn {
      display: inline-block;
      background: #003399;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 9px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      margin-top: 12px;
    }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .tab {
      background: #e5e7eb;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .tab.active {
      background: #003399;
      color: #fff;
    }
    .progress-wrap {
      margin-top: 12px;
      width: 100%;
      background: #e5e7eb;
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #003399 0%, #0099ff 100%);
      transition: width .25s ease;
    }
    pre#log {
      background: #111827;
      color: #e5e7eb;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Conversor XLSX → CSV (todas as abas)</h1>
    <p>Selecione um arquivo .xlsx. Vamos ler <strong>todas</strong> as planilhas e gerar um CSV para cada uma.</p>
    <label for="fileInput">Arquivo XLSX:</label>
    <input type="file" id="fileInput" accept=".xlsx,.xlsb,.xlsm,.xls" />
    <div id="status">Aguardando arquivo…</div>

    <div class="progress-wrap" aria-label="Progresso da conversão">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div id="sheetsContainer" style="margin-top: 14px;"></div>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Prévia do CSV (aba selecionada)</h2>
    <div class="tabs" id="tabs"></div>
    <textarea id="csvOutput" placeholder="O CSV da aba selecionada aparecerá aqui..." readonly></textarea>
  </div>

  <div class="card">
    <h2 style="margin-top:0;">Log</h2>
    <pre id="log">Nenhum erro até agora.</pre>
  </div>

  <script>
    // === inicia app normalmente (sem CDNs) ===
    window.addEventListener('load', function() {
      const fileInput = document.getElementById('fileInput');
      const csvOutput = document.getElementById('csvOutput');
      const statusEl = document.getElementById('status');
      const tabsEl = document.getElementById('tabs');
      const logEl = document.getElementById('log');
      const progressBar = document.getElementById('progressBar');
      const sheetsContainer = document.getElementById('sheetsContainer');

      let csvBySheet = {};
      let activeSheet = null;
      let baseFilename = 'planilha';

      function log(msg) {
        logEl.textContent += "\n" + msg;
      }

      fileInput.addEventListener('change', handleFile, false);

      function setProgress(p) {
        progressBar.style.width = p + '%';
      }

      async function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        statusEl.textContent = 'Lendo arquivo…';
        setProgress(5);
        log('Arquivo selecionado: ' + file.name);

        baseFilename = (file.name || 'planilha.xlsx').replace(/\.(xlsx|xlsm|xlsb|xls)$/i, '');

        const reader = new FileReader();

        reader.onload = function(evt) {
          try {
            setProgress(20);
            const data = evt.target.result;

            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            const sheetNames = workbook.SheetNames;

            if (!sheetNames || sheetNames.length === 0) {
              statusEl.textContent = 'Nenhuma aba encontrada no arquivo.';
              log('Nenhuma aba encontrada.');
              setProgress(0);
              return;
            }

            csvBySheet = {};
            sheetsContainer.innerHTML = '';
            tabsEl.innerHTML = '';
            activeSheet = null;

            const totalSheets = sheetNames.length;
            sheetNames.forEach((sheetName, idx) => {
              const worksheet = workbook.Sheets[sheetName];
              const csv = XLSX.utils.sheet_to_csv(worksheet, { FS: ';', RS: '\n' });
              csvBySheet[sheetName] = csv;

              const btn = document.createElement('button');
              btn.textContent = 'Baixar CSV: ' + sheetName;
              btn.className = 'btn';
              btn.style.marginRight = '8px';
              btn.addEventListener('click', () => downloadCSV(sheetName));
              sheetsContainer.appendChild(btn);

              const tab = document.createElement('div');
              tab.className = 'tab' + (idx === 0 ? ' active' : '');
              tab.textContent = sheetName;
              tab.addEventListener('click', () => selectSheet(sheetName));
              tabsEl.appendChild(tab);

              if (idx === 0) {
                activeSheet = sheetName;
                csvOutput.value = csv;
              }

              const prog = 20 + Math.floor(((idx + 1) / totalSheets) * 70);
              setProgress(prog);
            });

            statusEl.textContent = 'Convertido com sucesso! ' + totalSheets + ' aba(s) processada(s).';
            setProgress(100);
            setTimeout(() => setProgress(0), 2000);
            log('Conversão concluída.');
          } catch (err) {
            statusEl.textContent = 'Erro ao converter.';
            log('ERRO: ' + err.message);
            console.error(err);
            setProgress(0);
          }
        };

        reader.onerror = function(err) {
          statusEl.textContent = 'Erro ao ler o arquivo.';
          log('ERRO FileReader: ' + err.message);
          setProgress(0);
        };

        reader.readAsArrayBuffer(file);
      }

      function selectSheet(sheetName) {
        activeSheet = sheetName;
        csvOutput.value = csvBySheet[sheetName] || '';
        [...tabsEl.children].forEach(tab => {
          tab.classList.toggle('active', tab.textContent === sheetName);
        });
      }

      function downloadCSV(sheetName) {
        const csv = csvBySheet[sheetName];
        if (!csv) return;

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = baseFilename + '_' + sheetName + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    });
  </script>
</body>
</html>